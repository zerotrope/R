---
title:      "Survival Analysis project - Spring 18"
authors:    Melanie 
            Pras
            Lucas
---

Steps 
 - DONE // drop les predict actuels
 - DONE // split data set 312 : train(70%) validation(30%)
 - DONE // predict treatment on validation set with linear model
 - FIX // predict event death : test R² ou MAPE pour validation du modèle
 - FIX // predict sur les 106 test set
 - FIX // concatene tout le dataset complet (train+valid+test)
 - DONE // KM estimator 
 - Plot logrank curves
 - Plot cox baselin curves
 - check logrank curves pour troncate (juste un commentaire à faire), check jour Antonio Truncation video
 - chain les coxph pour identifier les variables significatives
 - analyse de résiduals
 - bonus: comparaison de modèles
 
Questions
 - intégrer les 19 patients transplantés dans les censurés?
 - coxph au début pour identifier les paramètres significatifs?
 - interprétation MAPE & R²?
 - on veut prédire le traitement ou la mort des 106?
 
-------------------------------------------------------------------------

# Introduction

Multiple tools and data for survival analysis are available in R packages such as "survival" from where we picked the PBC dataset. It comes from a clinical trial in the field of primary biliary cirrhosis conducted at the Mayo Clinic between 1974 and 1984. Primary biliary cirrhosis is a fatal chronic liver disease.

A total of 418 PBC patients were randomized to either a placebo or a drug called Dpenicillamine. Each of them was followed until death or censoring (the duration is measured in days). The status at endpoint is coded as follows: 0/1/2 for censored, transplant and dead respectively. In addition, 17 covariates are recorded for this study. These include a treatment variable, patient age, gender and clinical, biochemical and histologic measurements made at the time of randomization.

In this work, we will mainly consider the following variables: age (in years), serum albumin (g/dl), serum bilirubin (mg/dl), edema (0 if no edema, 0.5 if untreated or successfully treated and 1 if edema despite diuretic therapy) and prothrombin time (standardised blood clotting time).

# Data preparation

    Variable    Description
    ----------  -----------------------------------
    age:        in years
    albumin:	  serum albumin (g/dl)
    alk.phos:	  alkaline phosphotase (U/liter)
    ascites:	  presence of ascites
    ast:	      aspartate aminotransferase, once called SGOT (U/ml)
    bili:	      serum bilirunbin (mg/dl)
    chol:	      serum cholesterol (mg/dl)
    copper:	    urine copper (ug/day)
    edema:	    0 no edema, 0.5 untreated or successfully treated
                1 edema despite diuretic therapy
    hepato:	    presence of hepatomegaly or enlarged liver
    id:	        case number
    platelet:	  platelet count
    protime:	  standardised blood clotting time
    sex:	      m/f
    spiders:	  blood vessel malformations in the skin
    stage:	    histologic stage of disease (needs biopsy)
    status:	    status at endpoint, 0/1/2 for censored, transplant, dead
    time:	      number of days between registration and the earlier of death,
                transplantion, or study analysis in July, 1986
    trt:	      1/2/NA for D-penicillmain, placebo, not randomised
    trig:	      triglycerides (mg/dl)
    ----------  -----------------------------------

## Libraries importation

We also ground the present document on various other packages for data presentation and visualization (ie. gglopt2, readr, glmnet ...etc.).

```{r}
library(ggplot2)
library(readr)
library(glmnet)
library(survival)
?pbc
```

## Data visualizations

```{r}
#head(pbc)
#summary(pbc)
#hist(pbc$stage)
#table(pbc$stage)
```

## Specify event as status == "death"

Declare data importation and event association to the death of the patient.
Transplantation cases will not be of concerned in the context of a survival survival analysis, stricto sensu.

```{r}
# assign data set to a labelled object
data <- pbc
# create event parameter corresponding to death of the patient
data$event <- 0 + (data$status == 2)
```

## Convert all categorical data of the data set

```{r}
data$trt <- factor(data$trt)
data$status <- factor(data$status)
data$stage <- factor(data$stage)
data$ascites <- factor(data$ascites)
data$edema <- factor(data$edema)
data$spiders <- factor(data$spiders)
```

## Create age intervals

```{r}
hist(data$age)
data$ageGroup <- cut(data$age, breaks = c(0,10,20,30,40,50,60,70,80,90,Inf))
table(data$ageGroup)
```

## Input some missing values

```{r}
# cholesterol
fit.chol <- (lm(chol ~ age, data = data))
data$chol[is.na(data$chol)] <-
  predict(fit.chol, newdata = subset(data, is.na(chol)))
# copper
fit.copper <- (lm(copper ~ age, data = data))
data$copper[is.na(data$copper)] <-
  predict(fit.copper, newdata = subset(data, is.na(copper)))
# trig
fit.trig <- (lm(trig ~ age, data = data))
data$trig[is.na(data$trig)] <-
  predict(fit.trig, newdata = subset(data, is.na(trig)))
# platelet
fit.platelet <- (lm(platelet ~ age, data = data))
data$platelet[is.na(data$platelet)] <-
  predict(fit.platelet, newdata = subset(data, is.na(platelet)))
# check if NAs have been properly predicted
summary(data)
```

# Exploratory analysis

## Locate patients for survival analysis

Our patient's type-profile encompasses : 
 - patients that followed a treatment, thus excluding the 106 patients that did not;
 - patients concerned by the event of their death or consored, thus excluding the patients that were transplanted

```{r}
specimen <- subset(data, data$trt != "NA" & data$status != 1)
summary(specimen)
```

Getting a 293 observations data set on which we will run the survival analysis related tests as below.

## Create survival objects

Survival objects are created through the Surv(time, status) function from the "survival" package. To create right-censored data, this function needs two arguments:
 - time: returns the observed duration in days;
 - status: returns a boolean regarding whereas the observation corresponds to a censored one or not.

In the situation where status returns more than two modalities or if the modalities are not returning a boolean conditioned by the fact that the observations are censored or not, the formula creating the survival object must precise the proper modalities corresponding to censored observations.

/*
  Here with two time ranges, in days as by default in the data set and in
  months as computed ad hoc for lisibility
*/

```{r}
survival <- Surv(specimen$time / 365.25, specimen$event)

```

Hereby computed with time alteration to show yearly-basis scale for lisibility purpose of the reader.

## Kaplan-Meyer estimator - estimation of the survival function

Also known as "product-limit estimator", the Kaplan-Meyer estimator (KM) is a non-parametric statistic that allows us to estimate the survival function. It gives the probability that an individual patient will survive past a particular time t. It is based on the assumption that the probability of surviving past a certain time point t is equal to the product of the observed survival rates until time point t.
It is similar to the censoring version of empirical survival function, generating a stair-step curve but not accounting for effect of other covariates.
In R, the estimation of a survival function through the use of a survival object (ie. from censored data) is done thanks to the survfit(Surv(time, status), data) function of the "survival" package.

```{r}
KM <- survfit(survival ~ 1, data = specimen)
KM
plot(KM, xlab="Survival Years", ylab="Kaplan-Meyer Estimator")
```

## Mantel-Haenzel test - comparing two groups' own survival

Also known as log-rank test, it is a statistical hypothesis test that tests the null hypothesis that survival curves of two populations do not differ. It will output an indicator of the two groups being significantly different in terms of survival when its p-value will be inferior to risk threshold.
It is generated from a sequence of 2 by 2 tables measuring conditional independence. It is efficient in comparing groups differed by categorical variables, but not continuous ones.
In R, 

```{r}
MH <- survdiff(survival ~ specimen$trt)
MH
#plot(MH)
```

## Cox Model

Also known as proportional hazard model, conveniently accesses the effect of continuous and categorical variable using partial likelihood to get inference even without knowledge of baseline hazard.
Note that the assumption is strong.

```{r}
fit.coxph <- coxph(survival  ~ age + edema + hepato + platelet + sex + spiders + ascites + log(albumin) + log(alk.phos) + log(ast) + log(bili) + log(chol) + log(copper) + log(trig) + log(protime), data = specimen)
summary(fit.coxph)
```

We observe six covariates being significant to the data

```{r}
fit.coxph2 <- coxph(survival  ~ age + edema + log(albumin) + log(bili) + log(protime), data = specimen)
```


Visualizing the model:

```{r}
specimen.null<-data.frame(age=rep(0,1), edema=rep(0,1), bili=rep(1,1), albumin=rep(1,1), protime=rep(1,1))
# for baseline
plot(survfit(fit.coxph2, newdata=specimen.null), lwd=2,ylim=c(.99,1), main='baseline survivor', xlab='Years', ylab='Survival', conf.int=T)
# for mean covariates
plot(survfit(fit.coxph2),lwd=2,main= 'fitted survival function at mean covariates', xlab='Years', ylab='Survival')
```

## Diagnostic of Cox Model

```{r}

```
